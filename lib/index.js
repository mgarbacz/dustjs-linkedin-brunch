// Generated by CoffeeScript 1.6.3
var DustCompiler, dust, fs, npm, systemPath;

dust = require('dustjs-linkedin');

systemPath = require('path');

npm = require('npm');

fs = require('fs');

module.exports = DustCompiler = (function() {
  DustCompiler.prototype.brunchPlugin = true;

  DustCompiler.prototype.type = 'template';

  DustCompiler.prototype.extension = 'dust';

  function DustCompiler(config) {
    this.config = config;
    null;
  }

  DustCompiler.prototype.compile = function(data, path, callback) {
    var content, err, error, name, result, _ref;
    try {
      if ((_ref = this.config.modules) != null ? _ref.nameCleaner : void 0) {
        path = this.config.modules.nameCleaner(path);
      }
      name = path.replace(/\.dust$/, '');
      content = dust.compile(data, name);
      return result = "" + content + "\nif (typeof module !== 'undefined') {\n  module.exports = function(context, callback) {\n    dust.render(" + (JSON.stringify(name)) + ", context, callback);\n  };\n}";
    } catch (_error) {
      err = _error;
      return error = err;
    } finally {
      callback(error, result);
    }
  };

  DustCompiler.prototype.include = function() {
    var modulePackage, modulePath, moduleRoot, moduleVersion;
    modulePath = require.resolve('dustjs-linkedin');
    moduleRoot = systemPath.join(modulePath, '..', '..');
    modulePackage = require(systemPath.join(moduleRoot, 'package.json'));
    moduleVersion = modulePackage.version;
    return systemPath.join(moduleRoot, 'dist', 'dust-core-' + moduleVersion + '.js');
  };

  return DustCompiler;

})();
